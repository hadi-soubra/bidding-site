<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout</title>
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .checkout-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .order-summary {
      background: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
    }

    .order-item {
      display: flex;
      gap: 20px;
      padding-bottom: 20px;
      border-bottom: 2px solid #eee;
      margin-bottom: 20px;
    }

    .item-image-small {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      background: #f0f0f0;
    }

    .selection-section {
      background: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .selection-section h3 {
      color: #667eea;
      margin-bottom: 20px;
    }

    .option-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s;
    }

    .option-card:hover {
      border-color: #667eea;
    }

    .option-card.selected {
      border-color: #667eea;
      background: #f0f2ff;
    }

    .option-card input[type="radio"] {
      margin-right: 10px;
    }

    .total-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .total-line {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
    }

    .total-line.grand-total {
      font-size: 1.5rem;
      font-weight: bold;
      padding-top: 15px;
      border-top: 2px solid rgba(255,255,255,0.3);
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <nav>
      <div>
        <strong>üõí Checkout</strong>
      </div>
      <div class="nav-links">
        <a href="bidder-dashboard.html">‚Üê Back to Dashboard</a>
      </div>
    </nav>

    <div class="checkout-container">
      <div id="checkout-content">
        <div class="loading" style="text-align: center; padding: 50px; color: white;">
          Loading order...
        </div>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('order_id');

    if (!token || role !== 'bidder') {
      window.location.href = 'bidder-login.html';
    }

    if (!orderId) {
      alert('No order specified');
      window.location.href = 'bidder-dashboard.html';
    }

    let selectedPayment = null;
    let selectedAddress = null;

async function loadCheckout() {
  const content = document.getElementById('checkout-content');
  
  try {
    content.innerHTML = '<div style="text-align: center; padding: 50px; color: white;"><h3>Loading order...</h3></div>';
    
    // Load orders
    const ordersResponse = await fetch('http://localhost:3000/api/bidder/orders', {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!ordersResponse.ok) {
      throw new Error('Failed to load orders');
    }

    const orders = await ordersResponse.json();
    console.log('Orders loaded:', orders);

    const order = orders.find(o => o.order_id == orderId);

    if (!order) {
      content.innerHTML = '<div style="text-align: center; padding: 50px; color: white;"><h3>Order not found</h3><a href="bidder-dashboard.html" class="btn btn-primary">‚Üê Back</a></div>';
      return;
    }

    if (order.order_status !== 'pending_checkout') {
      content.innerHTML = '<div style="text-align: center; padding: 50px; color: white;"><h3>Order already completed</h3><a href="bidder-dashboard.html" class="btn btn-primary">‚Üê Back</a></div>';
      return;
    }

    content.innerHTML = '<div style="text-align: center; padding: 50px; color: white;"><h3>Loading payment methods...</h3></div>';

    // Load payment methods
    const paymentsResponse = await fetch('http://localhost:3000/api/bidder/payment-methods', {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!paymentsResponse.ok) {
      throw new Error('Failed to load payment methods');
    }

    const payments = await paymentsResponse.json();
    console.log('Payments loaded:', payments);

    content.innerHTML = '<div style="text-align: center; padding: 50px; color: white;"><h3>Loading addresses...</h3></div>';

    // Load addresses
    const addressesResponse = await fetch('http://localhost:3000/api/bidder/addresses', {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!addressesResponse.ok) {
      throw new Error('Failed to load addresses');
    }

    const addresses = await addressesResponse.json();
    console.log('Addresses loaded:', addresses);

    // Display checkout
    displayCheckout(order, payments, addresses);

  } catch (error) {
    console.error('Checkout error:', error);
    content.innerHTML = `
      <div style="text-align: center; padding: 50px; color: white;">
        <h3>Error loading checkout</h3>
        <p>${error.message}</p>
        <a href="bidder-dashboard.html" class="btn btn-primary">‚Üê Back to Dashboard</a>
      </div>
    `;
  }
}

function displayCheckout(order, payments, addresses) {
  document.getElementById('checkout-content').innerHTML = `
    <div class="order-summary">
      <h2>Order Summary</h2>
      <div class="order-item">
        <div class="item-image-small" style="display: flex; align-items: center; justify-content: center; color: #999;">
          üì¶
        </div>
        <div style="flex: 1;">
          <h3>${order.item_name}</h3>
          <p style="color: #666;">${order.item_category}</p>
          <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">Sold by: ${order.host_name}</p>
        </div>
        <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">
          $${order.final_price}
        </div>
      </div>
    </div>

    ${payments.length === 0 ? `
      <div class="selection-section">
        <p style="color: #666; text-align: center;">
          No payment methods saved. <a href="bidder-settings.html">Add one in Settings</a>
        </p>
      </div>
    ` : `
      <div class="selection-section">
        <h3>üí≥ Select Payment Method</h3>
        ${payments.map(p => `
          <label class="option-card" onclick="selectPayment(${p.payment_id})">
            <input type="radio" name="payment" value="${p.payment_id}">
            <strong>${p.payment_type}</strong>
            ${p.card_brand ? ' - ' + p.card_brand : ''}
            ${p.card_last_four ? ' ****' + p.card_last_four : ''}
            ${p.is_default ? ' <span style="color: #667eea;">(Default)</span>' : ''}
          </label>
        `).join('')}
      </div>
    `}

    ${addresses.length === 0 ? `
      <div class="selection-section">
        <p style="color: #666; text-align: center;">
          No addresses saved. <a href="bidder-settings.html">Add one in Settings</a>
        </p>
      </div>
    ` : `
      <div class="selection-section">
        <h3>üìç Select Shipping Address</h3>
        ${addresses.map(a => `
          <label class="option-card" onclick="selectAddress(${a.address_id})">
            <input type="radio" name="address" value="${a.address_id}">
            <strong>${a.address_line1}</strong><br>
            ${a.address_line2 ? a.address_line2 + '<br>' : ''}
            ${a.city}, ${a.state} ${a.postal_code}<br>
            ${a.country}
            ${a.is_default ? ' <span style="color: #667eea;">(Default)</span>' : ''}
          </label>
        `).join('')}
      </div>
    `}

    <div class="total-section">
      <div class="total-line grand-total">
        <span>Total:</span>
        <span>$${order.final_price}</span>
      </div>
    </div>

    <button onclick="completeCheckout()" class="btn btn-success" style="width: 100%; padding: 20px; font-size: 1.2rem;" id="checkout-btn" disabled>
      Complete Checkout
    </button>
  `;

  // Auto-select defaults after a short delay
  setTimeout(() => {
    const defaultPayment = payments.find(p => p.is_default);
    const defaultAddress = addresses.find(a => a.is_default);

    if (defaultPayment) selectPayment(defaultPayment.payment_id);
    if (defaultAddress) selectAddress(defaultAddress.address_id);
  }, 100);
}

window.selectPayment = function(id) {
  selectedPayment = id;
  document.querySelectorAll('input[name="payment"]').forEach(input => {
    input.parentElement.classList.toggle('selected', input.value == id);
  });
  checkComplete();
};

window.selectAddress = function(id) {
  selectedAddress = id;
  document.querySelectorAll('input[name="address"]').forEach(input => {
    input.parentElement.classList.toggle('selected', input.value == id);
  });
  checkComplete();
};

function checkComplete() {
  const btn = document.getElementById('checkout-btn');
  if (selectedPayment && selectedAddress) {
    btn.disabled = false;
  }
}

function checkComplete() {
  const btn = document.getElementById('checkout-btn');
  if (selectedPayment && selectedAddress) {
    btn.disabled = false;
  }
}

window.completeCheckout = async function() {
  if (!selectedPayment || !selectedAddress) {
    alert('Please select payment method and address');
    return;
  }

  try {
    const response = await fetch(`http://localhost:3000/api/orders/${orderId}/checkout`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        payment_id: selectedPayment,
        address_id: selectedAddress
      })
    });

    if (response.ok) {
      alert('‚úÖ Checkout completed! Your order has been placed.');
      window.location.href = 'bidder-dashboard.html';
    } else {
      const error = await response.json();
      alert(error.error);
    }
  } catch (error) {
    console.error('Checkout error:', error);
    alert('Checkout failed. Please try again.');
  }
};

loadCheckout();
</script>
</body>
</html>